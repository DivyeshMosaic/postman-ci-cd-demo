name: Run Postman Tests Only When Collection Updates

on:
  schedule:
    - cron: "*/2 * * * *"      # checks every 2 minutes for collection updates
  workflow_dispatch:           # allows manual trigger

jobs:
  check-and-run:
    runs-on: ubuntu-latest

    steps:
    - name: Restore version cache
      id: cache
      uses: actions/cache@v3
      with:
        path: postman_version.txt
        key: postman-collection-version

    - name: Fetch Collection Metadata
      id: meta
      run: |
        curl -s -X GET \
          "https://api.postman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}" \
          -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
          | jq -r '.collection.info.updatedAt' > latest_version.txt
        
        echo "LATEST_VERSION=$(cat latest_version.txt)" >> $GITHUB_ENV

    - name: Compare Versions
      id: compare
      run: |
        if [ -f postman_version.txt ]; then
          OLD_VERSION=$(cat postman_version.txt)
        else
          OLD_VERSION=""
        fi

        echo "Old version: $OLD_VERSION"
        echo "New version: $LATEST_VERSION"

        if [ "$OLD_VERSION" = "$LATEST_VERSION" ]; then
          echo "NO_CHANGE=true" >> $GITHUB_ENV
        else
          echo "$LATEST_VERSION" > postman_version.txt
          echo "NO_CHANGE=false" >> $GITHUB_ENV
        fi

    - name: Stop if no changes detected
      if: env.NO_CHANGE == 'true'
      run: |
        echo "No updates in Postman collection. Stopping workflow."
        exit 0

    - name: Install Postman CLI
      run: |
        curl -o- 'https://dl-cli.pstmn.io/install/linux64.sh' | sh

    - name: Login to Postman CLI
      run: |
        postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

    - name: Download latest Postman Collection
      run: |
        curl -s -X GET \
          "https://api.postman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}" \
          -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
          | jq '.collection' > latest_collection.json

    - name: Run Postman Collection
      run: |
        postman collection run latest_collection.json
